package vues;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.io.UnsupportedEncodingException;
import java.util.Calendar;

import BD.ElevesBDD;
import Modeles.Eleve;
import android.content.Context;
import android.os.Build;
import android.os.Environment;
import android.util.JsonReader;
import android.util.JsonWriter;

import com.example.cahierdeson.MainActivity;

public class SauvegardeFusion {

	Context ctx;
	public SauvegardeFusion(Context c) {
		// TODO Auto-generated constructor stub
		ctx=c;
	}
	public boolean importerEleveJsonInsertBD()
	{
		String filepath;
	    Calendar calendar = Calendar.getInstance();
	    int year = calendar.get(Calendar.YEAR);
	    InputStream input;
	    JsonReader reader;
	     String prenom = null;
	     String mot_de_pass= null;
	     String classe = null;
	    
	    filepath = Environment.getExternalStorageDirectory()+"/"+"CahierDeSon"+"/"+MainActivity.eleveConnecte.getClasse()+"_"+year+"/"+MainActivity.eleveConnecte.getPrenom();
		if((new File(filepath)).exists())
		{
			filepath = Environment.getExternalStorageDirectory()+"/"+"CahierDeSon"+"/"+MainActivity.eleveConnecte.getClasse()+"_"+year+"/"+MainActivity.eleveConnecte.getPrenom()+"/"+MainActivity.eleveConnecte.getPrenom()+"_SAVE"+".json";
			
			// on verifie que le fichier provient d'une autre tablette
			if(filepath.indexOf(Build.SERIAL)!=-1)
			{
				try {
					input = new FileInputStream(filepath);
					try {
						reader = new JsonReader(new InputStreamReader(input, "UTF-8"));
						try {
							reader.beginArray();
							 while (reader.hasNext()) {
								reader.beginObject();
							     while (reader.hasNext()) {
							       String name = reader.nextName();
							       if (name.equals("prenom")) {
							         prenom = reader.nextString();
							       } else if (name.equals("mot_de_pass")) {
							    	   mot_de_pass = reader.nextString();
							       }else if (name.equals("classe")) {
							    	   classe = reader.nextString();
							       }else {
							           reader.skipValue();
							       }
							     }
							     reader.endObject();	
						     }
						     reader.endArray();
						     
						     //insertion de l'élève dans la bd
						     Eleve el= new Eleve(prenom,mot_de_pass,classe);
						     ElevesBDD bd = new ElevesBDD(ctx);
						     bd.open();
						     bd.insertEleve(el);
						     bd.close();
						     
						     return true;
						     
						} catch (IOException e) {
							// TODO Auto-generated catch block
							e.printStackTrace();
						}
					     
					} catch (UnsupportedEncodingException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					
				} catch (FileNotFoundException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			}
		}
		
		return false;
		
	}
	
		
	public void exporterEleveJson()
	{
		String filepath;
	    Calendar calendar = Calendar.getInstance();
	    int year = calendar.get(Calendar.YEAR);
	    OutputStream output;
	    JsonWriter writer;
	
		filepath = Environment.getExternalStorageDirectory()+"/"+"CahierDeSon"+"/"+MainActivity.eleveConnecte.getClasse()+"_"+year+"/"+MainActivity.eleveConnecte.getPrenom();
		if((new File(filepath)).exists())
		{
			filepath = Environment.getExternalStorageDirectory()+"/"+"CahierDeSon"+"/"+MainActivity.eleveConnecte.getClasse()+"_"+year+"/"+MainActivity.eleveConnecte.getPrenom()+"/"+MainActivity.eleveConnecte.getPrenom()+"_"+Build.SERIAL+".json";
			try {
				output = new FileOutputStream(filepath);
				try {
					writer = new JsonWriter(new OutputStreamWriter(output, "UTF-8"));
					writer.setIndent("  ");
					writer.beginObject();
					writer.name("prenom").value(MainActivity.eleveConnecte.getPrenom());
					writer.name("mot_de_pass").value(MainActivity.eleveConnecte.getMotDePasse());
					writer.name("classe").value(MainActivity.eleveConnecte.getClasse());
					writer.endObject();
					
				} catch (UnsupportedEncodingException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			     
			} catch (FileNotFoundException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			
		}
		
		
		 
		
	}
	


}
